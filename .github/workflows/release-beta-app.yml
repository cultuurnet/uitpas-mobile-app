name: Release beta

on:
  workflow_dispatch:
  pull_request:
    branches:
      - develop
    types: [closed]

env:
  BUILD_NUMBER: ${{ github.run_number }}

jobs:
  release_beta_ios:
    name: iOS (beta)
    environment: beta
    runs-on: macos-15
    if:
      github.event_name == 'workflow_dispatch' || (startsWith(github.head_ref, 'release/') && github.event.pull_request.merged ==
      true)
    steps:
      - name: Notarize Release Build
        uses: apple-actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
          p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
      - uses: actions/checkout@v3
      - uses: nyaa8/package-version@v1
        name: Fetch current version
      - name: create-json
        id: create-json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: 'credentials.json'
          json: ${{ secrets.FIREBASE_UPLOAD_CREDENTIAL }}
          dir: 'fastlane/'
      # - name: Create .env file
      #   run: |
      #     touch .env
      #     echo EXPO_PUBLIC_NODE_ENV=beta >> .env
      #     echo EXPO_PUBLIC_APP_NAME="${{ secrets.APP_NAME }}" >> .env
      #     echo EXPO_PUBLIC_APP_PACKAGE_NAME="${{ secrets.APP_PACKAGE_NAME }}" >> .env
      #     echo EXPO_PUBLIC_APP_VERSION="${{ env.PACKAGE_VERSION }}" >> .env
      #     echo EXPO_PUBLIC_APP_LOGGING_LEVEL=info >> .env
      #     echo EXPO_PUBLIC_APP_ICON="${{ secrets.APP_ICON }}" >> .env
      #     echo EXPO_PUBLIC_APP_ADAPTIVE_ICON="${{ secrets.APP_ADAPTIVE_ICON }}" >> .env
      #     echo EXPO_PUBLIC_APP_ADAPTIVE_ICON_BACKGROUND_COLOR="${{ secrets.APP_ADAPTIVE_ICON_BG_COLOR }}" >> .env
      #     echo EXPO_PUBLIC_AUTH_CLIENT_ID="${{ secrets.AUTH_CLIENT_ID }}" >> .env
      #     echo EXPO_PUBLIC_AUTH_ISSUER="${{ secrets.AUTH_ISSUER }}" >> .env
      #     echo EXPO_PUBLIC_API_HOST="${{ secrets.API_HOST }}" >> .env
      #     echo EXPO_PUBLIC_API_HOST_UITDATABANK="${{ secrets.API_HOST_UITDATABANK }}" >> .env
      #     echo EXPO_PUBLIC_APP_ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" >> .env
      #     echo EXPO_PUBLIC_SENTRY_DSN="${{ secrets.SENTRY_DSN }}" >> .env
      #     echo EXPO_PUBLIC_TRACKING_HOST="${{ secrets.TRACKING_HOST }}" >> .env
      #     cat .env
      # - uses: actions/setup-node@v3
      #   with:
      #     node-version-file: .nvmrc
      # - name: Enable Corepack
      #   run: corepack enable
      # - name: Prepare pnpm
      #   run: corepack prepare pnpm@10.23.0 --activate
      # - name: Install dependencies
      #   run: pnpm install
      # - name: Expo prebuild for iOS
      #   run: npx expo prebuild --clean --platform ios
      # - run: fastlane build env:beta ios:true
      #   env:
      #     CI_IOS_TEAM_ID: 'FAJTRUZ6J9'
      #     CI_IOS_CODE_SIGN_IDENTITY: 'iPhone Distribution'
      #     CI_IOS_PROVISIONING_PROFILE: 'fastlane/compubliquitpas_Beta.mobileprovision'
      #     CI_IOS_USERNAME: '${{ secrets.CI_IOS_USERNAME }}'
      #     CI_IOS_TEAM_NAME: 'DAG 22 BVBA'
      #     CI_IOS_APPLE_ID: '${{ secrets.CI_IOS_APPLE_ID }}'
      #     CI_FIREBASE_IOS_APP_ID: ${{ secrets.CI_FIREBASE_IOS_APP_ID }}
      #     CI_FIREBASE_IOS_GROUPS: 'Publiq'
  release_beta_android:
    name: Android (beta)
    environment: beta
    runs-on: macos-15
    if:
      github.event_name == 'workflow_dispatch' || (startsWith(github.head_ref, 'release/') && github.event.pull_request.merged ==
      true)
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}
      - uses: nyaa8/package-version@v1
        name: Fetch current version
      - name: create-json
        id: create-json
        uses: jsdaniell/create-json@v1.2.3
        with:
          name: 'credentials.json'
          json: ${{ secrets.FIREBASE_UPLOAD_CREDENTIAL }}
          dir: 'fastlane/'
      - name: Create .env file
        run: |
          touch .env
          echo EXPO_PUBLIC_NODE_ENV=beta >> .env
          echo EXPO_PUBLIC_APP_NAME="${{ secrets.APP_NAME }}" >> .env
          echo EXPO_PUBLIC_APP_PACKAGE_NAME="${{ secrets.APP_PACKAGE_NAME }}" >> .env
          echo EXPO_PUBLIC_APP_VERSION="${{ env.PACKAGE_VERSION }}" >> .env
          echo EXPO_PUBLIC_APP_LOGGING_LEVEL=info >> .env
          echo EXPO_PUBLIC_APP_ICON="${{ secrets.APP_ICON }}" >> .env
          echo EXPO_PUBLIC_APP_ADAPTIVE_ICON="${{ secrets.APP_ADAPTIVE_ICON }}" >> .env
          echo EXPO_PUBLIC_APP_ADAPTIVE_ICON_BACKGROUND_COLOR="${{ secrets.APP_ADAPTIVE_ICON_BG_COLOR }}" >> .env
          echo EXPO_PUBLIC_AUTH_CLIENT_ID="${{ secrets.AUTH_CLIENT_ID }}" >> .env
          echo EXPO_PUBLIC_AUTH_ISSUER="${{ secrets.AUTH_ISSUER }}" >> .env
          echo EXPO_PUBLIC_API_HOST="${{ secrets.API_HOST }}" >> .env
          echo EXPO_PUBLIC_API_HOST_UITDATABANK="${{ secrets.API_HOST_UITDATABANK }}" >> .env
          echo EXPO_PUBLIC_APP_ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" >> .env
          echo EXPO_PUBLIC_SENTRY_DSN="${{ secrets.SENTRY_DSN }}" >> .env
          echo EXPO_PUBLIC_TRACKING_HOST="${{ secrets.TRACKING_HOST }}" >> .env
          cat .env
      - uses: actions/setup-node@v3
        with:
          node-version-file: .nvmrc
      - name: Enable Corepack
        run: corepack enable
      - name: Prepare pnpm
        run: corepack prepare pnpm@10.23.0 --activate
      - name: Install dependencies
        run: pnpm install
      - name: Expo prebuild for Android
        run: npx expo prebuild --clean --platform android
      - uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
      - run: fastlane build env:beta android:true
        env:
          STORE_FILE: debug.keystore
          STORE_PASSWORD: android
          KEY_ALIAS: androiddebugkey
          KEY_PASSWORD: android
          CI_FIREBASE_ANDROID_APP_ID: ${{ secrets.CI_FIREBASE_ANDROID_APP_ID }}
          CI_FIREBASE_ANDROID_GROUPS: 'Publiq'
      - name: Upload Android APK
        if: always()
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: android-build-${{ github.run_id }}
          path: android/app/build/outputs/apk/release/app-release.apk
          retention-days: 30
  create_release:
    name: Create release
    needs: [release_beta_ios, release_beta_android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ env.BRANCH }}
      - uses: nyaa8/package-version@v1
        name: Fetch current version
      - name: Run latest-tag
        uses: EndBug/latest-tag@latest
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          prerelease: true
          tag_name: ${{ env.PACKAGE_VERSION }}
